#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import syd
import click
import shutil
import os
import tqdm
from anonymize import *

def copytree(src, dst):
    os.mkdir(dst)
    pbar = tqdm.tqdm()
    for root, dirs, files in os.walk(src):
        for dir in dirs:
            os.mkdir(os.path.join(dst, os.path.join(root, dir)[len(src)+1:]))
            pbar.update(1)
        for file in files:
            shutil.copyfile(os.path.join(root, file), os.path.join(dst, os.path.join(root, file)[len(src)+1:]))
            pbar.update(1)
    pbar.close()
    print("Copy done")


# -----------------------------------------------------------------------------
CONTEXT_SETTINGS = dict(help_option_names=['-h', '--help'])

@click.command(context_settings=CONTEXT_SETTINGS)
@click.argument('database')
@click.option('-a', '--anonymize', is_flag=True, help='Anonymize the database')
@click.option('-o', '--output', default='.',
              help='Output folder containing the databaset')
def syd_copy_db(database, anonymize, output):
    """
    Copy the database and associated files in output folder
    mhd/raw images are copied
    Anonymize the data: Remove dicom patient id inside DB
    and anonymize dicom files
    !!! syd_algo scripts have to be in your PATH
    """

    output = os.path.abspath(output)
    if len(os.listdir(output)) > 0:
        print("Error: Output folder " + output + " is not empty")
        return()

    shutil.copyfile(database, os.path.join(output, os.path.basename(database)))
    db = syd.open_db(database)
    outputDBFolder = os.path.join(output, os.path.basename(db.absolute_data_folder))
    copytree(db.absolute_data_folder, outputDBFolder)

    #Change folder in file table
    newDb = syd.open_db(os.path.join(output, os.path.basename(database)))
    dbi = newDb['Info']
    elements = syd.find(dbi)
    elements[0].image_folder =  os.path.join(output, os.path.basename(db.absolute_data_folder))[len(os.path.dirname(os.path.join(output, os.path.basename(database))))+1:]
    elements[0].online_repo = "tux.creatis.insa-lyon.fr:/home/baudier/studies/syd/lutathera/"
    syd.update(newDb['Info'], elements)

    if anonymize:
        #Remove all dicom patient id in database and anonymize dicom
        newDb = syd.open_db(os.path.join(output, os.path.basename(database)))
        patients = syd.find(newDb['Patient'])
        folder = syd.find(newDb['Info'])[0].image_folder
        pbar = tqdm.tqdm(total=len(patients))
        for patient in patients:
            patient.dicom_id = str(patient.anonymous_id)
            anonymizeDicom(os.path.join(outputDBFolder, patient.name), False, patient.name, patient.anonymous_id)
            #Remove original files and Move the anonymized ones
            for element in os.listdir(os.path.join(outputDBFolder, patient.name, "anonymizationOutput")):
                if os.path.isdir(os.path.join(outputDBFolder, patient.name, element)):
                    shutil.rmtree(os.path.join(outputDBFolder, patient.name, element))
                    shutil.move(os.path.join(outputDBFolder, patient.name, "anonymizationOutput", element), os.path.join(outputDBFolder, patient.name, element))
                else:
                    os.remove(os.path.join(outputDBFolder, patient.name, element))
                    shutil.move(os.path.join(outputDBFolder, patient.name, "anonymizationOutput", element), os.path.join(outputDBFolder, patient.name, element))
            shutil.rmtree(os.path.join(outputDBFolder, patient.name, "anonymizationOutput"))
            pbar.update(1)
        pbar.close()

        syd.update(newDb['Patient'], patients)


# -----------------------------------------------------------------------------
if __name__ == '__main__':
    syd_copy_db()
