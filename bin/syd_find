#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import syd
import click
import re
import os

# -----------------------------------------------------------------------------
CONTEXT_SETTINGS = dict(help_option_names=['-h', '--help'])
@click.command(context_settings=CONTEXT_SETTINGS)
@click.argument('table_name')
@click.argument('grep', nargs=-1)
@click.option('--db', default='',
              help='DB filename (SYD_DB_FILENAME environment variable is used if no filename)')
@click.option('--print_format', '-f', default='default',
              help='Print format')
@click.option('--delete/--no-delete', '-d', default=False,
              help='Delete found elements')
@click.option('--short/--no-short', '-s', default=False,
              help='If true, only display results id (for piped commands)')
@click.option('--id', '-i', multiple=True,
              help='Only display elements with given id (maybe multiple)')
@click.option('--vv/--no-vv', default=False,
              help='Try to open in VV')
def syd_find(table_name, grep, db, print_format, delete, short, id, vv):
    '''
    FIXME

    grep: display results that match all (AND) words given. For OR, use something like "A|B"
    '''

    # open the db
    db_filename = syd.get_db_filename(db)
    db = syd.open_db(db_filename)

    # check table exist FIXME --> check lowercase ?
    if not table_name in db:
        print('Table {} does not exist. Tables: {}'.format(table_name, db.tables))
        exit(0)
    table = db[table_name]

    # get elements
    if len(id) == 0:
        #elements = table.all()
        elements = syd.find_all(table)
    else:
        #elements = table.find(id=id)
        elements = syd.find(table, id=id)

    # grep
    res = []
    if len(grep) == 0:
        res = [e for e in elements]
    else:
        for e in elements:
            s = ''.join(str(x) for x in e.values())
            found=True
            for g in grep:
                if not re.search(g, s):
                    found=False
                    break
            if found:
                res.append(e)

    if len(res) == 0:
        return

    if short:
        s=''
        for e in res:
            s = s+str(e['id'])+' '
        print(s)
        exit()

    # print tables and columns
    s = ''
    for col in db[table_name].table.columns:
        c = str(col)[len(table_name)+1:]
        s = s+c+' '
    print(s)

    # print
    syd.print_elements(table_name, print_format, res)

    # vv ?
    if vv:
        filenames = ''
        for e in res:
            try:
                filename = syd.get_image_filename(db, e)
                filenames = filenames + ' ' + filename
            except:
                filename = '' ## nothing
        if filenames != '':
            print('vv '+filenames)
            os.system('vv '+filenames) # to be changed by subprocess

    # print nb found
    if len(res) == 1:
        print('Found 1 element')
    else:
        print('Found {} elements'.format(len(res)))

    if delete:
        ids = [i['id'] for i in res]
        syd.delete(db[table_name], ids)
        print('Delete: ',ids)


# -----------------------------------------------------------------------------
if __name__ == '__main__':
    syd_find()

